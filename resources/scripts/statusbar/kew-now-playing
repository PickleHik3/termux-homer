#!/bin/bash
CACHE="$HOME/.cache/kew-now-playing"
OFFSET_FILE="$HOME/.cache/kew-ticker-offset"
TMP_DIR="/data/data/com.termux/files/usr/tmp"
WIDTH=30  # visible ticker width
SPEED=4   # characters to scroll per refresh

# Find D-Bus socket with kew MPRIS
find_kew_socket() {
    for sock in "$TMP_DIR"/dbus-*; do
        [[ -S "$sock" ]] || continue
        export DBUS_SESSION_BUS_ADDRESS="unix:path=$sock"
        if dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
            /org/freedesktop/DBus org.freedesktop.DBus.ListNames 2>/dev/null | grep -q "org.mpris.MediaPlayer2.kew"; then
            echo "$sock"
            return 0
        fi
    done
    return 1
}

# Get metadata from kew
get_now_playing() {
    sock=$(find_kew_socket) || return 1
    export DBUS_SESSION_BUS_ADDRESS="unix:path=$sock"

    metadata=$(dbus-send --session --print-reply --dest=org.mpris.MediaPlayer2.kew \
        /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
        string:'org.mpris.MediaPlayer2.Player' string:'Metadata' 2>/dev/null) || return 1

    title=$(echo "$metadata" | grep -A1 'string "xesam:title"' | tail -1 | sed 's/.*string "\(.*\)"/\1/')
    artist=$(echo "$metadata" | grep -A3 'string "xesam:artist"' | grep 'string "' | tail -1 | sed 's/.*string "\(.*\)"/\1/')

    [[ -n "$title" ]] && echo "$artist - $title"
}

# Ticker function - scrolls text (UTF-8 safe using bash substring)
ticker() {
    local text="$1"
    local len=${#text}

    # If text fits in width, just return it as-is
    if (( len <= WIDTH )); then
        printf '%s' "$text"
        return
    fi

    # Add padding for smooth wrap-around
    local padded_text="$text    ++    "
    local padded_len=${#padded_text}

    # Read current offset
    local offset=0
    if [[ -f "$OFFSET_FILE" ]]; then
        offset=$(<"$OFFSET_FILE") || offset=0
    fi

    # Double the text for seamless wrap, extract visible portion (bash handles UTF-8)
    local doubled="${padded_text}${padded_text}"
    local visible="${doubled:offset:WIDTH}"

    # Trim trailing spaces
    visible="${visible%"${visible##*[! ]}"}"
    printf '%s' "$visible"

    # Update offset for next refresh
    local new_offset=$(( (offset + SPEED) % padded_len ))
    echo "$new_offset" > "$OFFSET_FILE"
}

# Main
# If kew isn't running, clear cache and exit
if ! pgrep -x kew >/dev/null 2>&1; then
    rm -f "$CACHE" "$OFFSET_FILE"
    exit 0
fi

result=$(get_now_playing 2>/dev/null)
if [[ -n "$result" ]]; then
    echo "$result" > "$CACHE"
    printf '♪ '
    ticker "$result"
elif [[ -f "$CACHE" ]]; then
    # kew is running but MPRIS briefly unavailable - use cache
    printf '♪ '
    ticker "$(<"$CACHE")"
fi
